---
title: "Project2 Applied Stats Initial EDA"
author: "Halle Purdom"
date: "7/18/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Notes:
-make shared repo if nobody does it in a few days
-Eda, some techniques for var selection, ELi said he would do some PCA prof showed us in class, #EDA + Objective 1: Logistic Model
-Meet next weekend ish- play it by ear
-upload personal work to repo

Meeting 2:
Down or Up sampling- there's a package in R

Dataset Info: 
Input variables:
# bank client data:
1 - age (numeric)
2 - job : type of job (categorical: 'admin.','blue-collar','entrepreneur','housemaid','management','retired','self-employed','services','student','technician','unemployed','unknown')
3 - marital : marital status (categorical: 'divorced','married','single','unknown'; note: 'divorced' means divorced or widowed)
4 - education (categorical: 'basic.4y','basic.6y','basic.9y','high.school','illiterate','professional.course','university.degree','unknown')
5 - default: has credit in default? (categorical: 'no','yes','unknown')
6 - housing: has housing loan? (categorical: 'no','yes','unknown')
7 - loan: has personal loan? (categorical: 'no','yes','unknown')
# related with the last contact of the current campaign:
8 - contact: contact communication type (categorical: 'cellular','telephone')
9 - month: last contact month of year (categorical: 'jan', 'feb', 'mar', ..., 'nov', 'dec')
10 - day_of_week: last contact day of the week (categorical: 'mon','tue','wed','thu','fri')
11 - duration: last contact duration, in seconds (numeric). Important note: this attribute highly affects the output target (e.g., if duration=0 then y='no'). Yet, the duration is not known before a call is performed. Also, after the end of the call y is obviously known. Thus, this input should only be included for benchmark purposes and should be discarded if the intention is to have a realistic predictive model.
# other attributes:
12 - campaign: number of contacts performed during this campaign and for this client (numeric, includes last contact)
13 - pdays: number of days that passed by after the client was last contacted from a previous campaign (numeric; 999 means client was not previously contacted)
14 - previous: number of contacts performed before this campaign and for this client (numeric)
15 - poutcome: outcome of the previous marketing campaign (categorical: 'failure','nonexistent','success')
# social and economic context attributes
16 - emp.var.rate: employment variation rate - quarterly indicator (numeric)
17 - cons.price.idx: consumer price index - monthly indicator (numeric)
18 - cons.conf.idx: consumer confidence index - monthly indicator (numeric)
19 - euribor3m: euribor 3 month rate - daily indicator (numeric)
20 - nr.employed: number of employees - quarterly indicator (numeric)

Output variable (desired target):
21 - y - has the client subscribed a term deposit? (binary: 'yes','no')

#Loading libraries
```{r}
library(naniar)
library(ggplot2)
library(plyr)
library(plyr)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(GGally)
library(aplore3)
library(gplots)
library(ResourceSelection)
library(ggplot2)
library(rgl) ##For mac users you may need to download Xquartz before the 3d plots
#will run.
library(tree)
library(ISLR)
library(randomForest)
```

#Bank Data: Predicting if a customer will subscribe to a term deposit.
```{r}
bank_raw<- read.csv(file = "/Users/hallepurdom/Desktop/SMU/Classes/Applied Statistics/Project 2 Details 2021/Bank/bank-additional/bank-additional-full.csv", header= TRUE, sep=";")
head(bank_raw)
str(bank_raw)
```
#Summary Only
```{r}
summary(bank_raw)
```
#Changing Var Types
```{r}
bank<- bank_raw

bank$job <- as.factor(bank$job)
bank$marital<-as.factor(bank$marital)
bank$education<-as.factor(bank$education)
bank$default<-as.factor(bank$default)
bank$housing <-as.factor(bank$housing)
bank$loan <-as.factor(bank$loan)
bank$contact <-as.factor(bank$contact)
bank$month <-as.factor(bank$month)
bank$day_of_week <-as.factor(bank$day_of_week)

bank$poutcome <-as.factor(bank$poutcome)

bank$y <- as.factor(bank$y)

str(bank)
```

#Summary Statistics for Numeric Explanatories (Aggregate Function) - run in console to see results, won't print in Rmd
```{r}
aggregate(age~y, data=bank, summary)
aggregate(duration~y, data=bank, summary)
aggregate(campaign~y, data=bank, summary)
aggregate(pdays~y, data=bank, summary)
aggregate(previous~y, data=bank, summary)
aggregate(emp.var.rate~y, data=bank, summary)
aggregate(cons.price.idx~y, data=bank, summary)
aggregate(cons.conf.idx~y, data=bank, summary)
aggregate(euribor3m~y, data=bank, summary)
aggregate(nr.employed~y, data=bank, summary)
```
#Count Tables for Categorical Explanatories
```{r}
ftable(addmargins(table(bank$y,bank$job)))
ftable(addmargins(table(bank$y,bank$marital)))
ftable(addmargins(table(bank$y,bank$education)))
ftable(addmargins(table(bank$y,bank$default)))
ftable(addmargins(table(bank$y,bank$housing)))
ftable(addmargins(table(bank$y,bank$loan)))
ftable(addmargins(table(bank$y,bank$contact)))
ftable(addmargins(table(bank$y,bank$month)))
ftable(addmargins(table(bank$y,bank$day_of_week)))
ftable(addmargins(table(bank$y,bank$poutcome)))
```
#Proportion Count Tables for Categorical Explanatories
```{r}
prop.table(table(bank$y,bank$job),2)
prop.table(table(bank$y,bank$marital),2)
prop.table(table(bank$y,bank$education),2)
prop.table(table(bank$y,bank$default),2)
prop.table(table(bank$y,bank$housing),2)
prop.table(table(bank$y,bank$loan),2)
prop.table(table(bank$y,bank$contact),2)
prop.table(table(bank$y,bank$month),2)
prop.table(table(bank$y,bank$day_of_week),2)
prop.table(table(bank$y,bank$poutcome),2)
```
#Visualize Numeric
```{r}
plot(bank$age~bank$y,col=c("red","blue"))
plot(bank$duration~bank$y,col=c("red","blue"))
plot(bank$campaign~bank$y,col=c("red","blue"))
plot(bank$pdays~bank$y,col=c("red","blue"))
plot(bank$previous~bank$y,col=c("red","blue"))
plot(bank$emp.var.rate~bank$y,col=c("red","blue"))
plot(bank$cons.price.idx~bank$y,col=c("red","blue"))
plot(bank$cons.conf.idx~bank$y,col=c("red","blue"))
plot(bank$euribor3m~bank$y,col=c("red","blue"))
plot(bank$nr.employed~bank$y,col=c("red","blue"))
```
#Visualize Categorical
```{r}
plot(bank$y~bank$job,col=c("red","blue"))
plot(bank$y~bank$marital,col=c("red","blue"))
plot(bank$y~bank$education,col=c("red","blue"))
plot(bank$y~bank$default,col=c("red","blue"))
plot(bank$y~bank$housing,col=c("red","blue"))
plot(bank$y~bank$loan,col=c("red","blue"))
plot(bank$y~bank$contact,col=c("red","blue"))
plot(bank$y~bank$month,col=c("red","blue"))
plot(bank$y~bank$day_of_week,col=c("red","blue"))
plot(bank$y~bank$poutcome,col=c("red","blue"))
```
#Correlation between Continuos predictors
```{r}
#pairs(bank[,c(1,11:14,16:20)])
#my.cor<-cor(bank[,c(1,11:14,16:20)])
#my.cor
#pairs(bank[,c(1,11:14,16:20)],col=bank$y)

pairs(bank[,16:20],col=bank$y)
pairs(bank[,c(1,11:14)],col=bank$y)

my.cor<-cor(bank[,c(1,11:14,16:20)])
my.cor

heatmap.2(my.cor,col=redgreen(75), 
          density.info="none", trace="none", dendrogram=c("row"), 
          symm=F,symkey=T,symbreaks=T, scale="none")
```
#PCA with Continous predictors
```{r}
pc.result<-prcomp(bank[,c(1,11:14,16:20)],scale.=TRUE)
pc.scores<-pc.result$x
pc.scores<-data.frame(pc.scores)
pc.scores$mpg<-bank$y

ggplot(data = pc.scores, aes(x = PC1, y = PC2)) +
  geom_point(aes(col=bank$y), size=1)+
  ggtitle("PCA of Bank")
```
#Logistic Regression: Full Model (no selection happening here)
```{r}
model.main<-glm(y ~ ., data=bank,family = binomial(link="logit"))
#(vif(model.main)[,3])^2
hoslem.test(model.main$y, fitted(model.main), g=10)
summary(model.main)
exp(cbind("Odds ratio" = coef(model.main), confint.default(model.main, level = 0.95)))
plot(model.main) #residual diagnostics
```
#Logistic Model from Null by Chisquared (Forward Selection I think...)
```{r}
model.null<-glm(y ~ 1, data=bank,family = binomial(link="logit"))
step(model.null,
     scope = list(upper=model.main),
     direction="forward",
     test="Chisq",
     data=newAuto)

#Resulting model: y ~ duration + nr.employed + month + poutcome + emp.var.rate + cons.price.idx + job + contact + euribor3m + default + day_of_week + pdays + campaign + cons.conf.idx
```

Step:  AIC=17170.27
y ~ duration + nr.employed + month + poutcome + emp.var.rate + 
    cons.price.idx + job + contact + euribor3m + default + day_of_week + 
    pdays + campaign + cons.conf.idx

            Df Deviance   AIC     LRT Pr(>Chi)  
<none>            17094 17170                   
+ previous   1    17093 17171  1.0670  0.30163  
+ education  7    17082 17172 12.6638  0.08074 .
+ age        1    17094 17172  0.5029  0.47822  
+ loan       2    17093 17173  1.1604  0.55978  
+ housing    2    17094 17174  0.3793  0.82724  
+ marital    3    17092 17174  2.2730  0.51772  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Call:  glm(formula = y ~ duration + nr.employed + month + poutcome + 
    emp.var.rate + cons.price.idx + job + contact + euribor3m + 
    default + day_of_week + pdays + campaign + cons.conf.idx, 
    family = binomial(link = "logit"), data = bank)

Coefficients:
        (Intercept)             duration          nr.employed             monthaug             monthdec  
         -2.323e+02            4.702e-03            5.116e-03            8.674e-01            3.019e-01  
           monthjul             monthjun             monthmar             monthmay             monthnov  
          1.361e-01           -5.115e-01            2.019e+00           -4.553e-01           -4.253e-01  
           monthoct             monthsep  poutcomenonexistent      poutcomesuccess         emp.var.rate  
          1.803e-01            3.607e-01            5.026e-01            1.036e+00           -1.752e+00  
     cons.price.idx       jobblue-collar      jobentrepreneur         jobhousemaid        jobmanagement  
          2.160e+00           -3.329e-01           -2.029e-01           -1.118e-01           -4.317e-02  
         jobretired     jobself-employed          jobservices           jobstudent        jobtechnician  
          2.047e-01           -1.509e-01           -2.128e-01            1.770e-01           -2.728e-02  
      jobunemployed           jobunknown     contacttelephone            euribor3m       defaultunknown  
         -3.686e-02           -9.286e-02           -6.421e-01            3.422e-01           -3.106e-01  
         defaultyes       day_of_weekmon       day_of_weekthu       day_of_weektue       day_of_weekwed  
         -7.326e+00           -1.172e-01            5.858e-02            9.500e-02            1.727e-01  
              pdays             campaign        cons.conf.idx  
         -8.445e-04           -3.981e-02            2.039e-02  

Degrees of Freedom: 41187 Total (i.e. Null);  41150 Residual
Null Deviance:	    29000 
Residual Deviance: 17090 	AIC: 17170


#ERROR!!!!!  Stepwise
```{r}
library(MASS)
library(tidyverse)
full.log<-glm(y~.,family="binomial",data=bank) #for train/test, replace data=train
step.log<-full.log %>% stepAIC(trace=FALSE)
summary(step.log)
exp(cbind("Odds ratio" = coef(step.log), confint.default(step.log, level = 0.95)))

```

#ERROR!!!!! LASSO (getting error at end)
```{r}
library(glmnet)

set.seed(1234)
index<-sample(1:41188,20594,replace=FALSE)
test<-bank[-index,]
train<-bank[index,]

dat.train.x <- model.matrix(y~.,train)
dat.train.y<-train[,21]
#data.train.y <- as.matrix(y.train.predictor)

cvfit <- cv.glmnet(dat.train.x, dat.train.x, family = "binomial", type.measure = "class")
plot(cvfit)
coef(cvfit, s = "lambda.min")
#CV misclassification error rate is little below .1
print("CV Error Rate:")
cvfit$cvm[which(cvfit$lambda==cvfit$lambda.min)]

#Optimal penalty
print("Penalty Value:")
cvfit$lambda.min

#For final model predictions go ahead and refit lasso using entire
#data set
finalmodel<-glmnet(dat.train.x, dat.train.y, family = "binomial",lambda=cvfit$lambda.min)
```


#Tree
```{r}

y2 <- as.factor(bank$y)
bank2=data.frame(bank,y2)

set.seed(2)
train=sample(1:nrow(bank2),20594) #split in half
bank2.test=bank2[-train,]

y2.test=y2[-train]

tree.bank2=tree(y2~.-y, bank2, subset=train)
tree.pred=predict(tree.bank2, bank2.test, type="class")
table(tree.pred,y2.test)

summary(tree.bank2)

#Overall Accuracy: TP+TN/total
(17195+1433)/41188
#Sensitivity: TP/P
(1433)/(1433+850)
#Specificity: TN/N
(17195)/(17195+1116)

```

#Pruning tree CV -- varifies 8 node tree is best
```{r}
set.seed(3)
par(mfrow=c(1,1))
cv.bank2=cv.tree(tree.bank2,FUN=prune.misclass)
names(cv.bank2)
plot(cv.bank2) #tree is best size already (8)

#Fit the pruned tree and visualize
prune.bank2=prune.misclass(tree.bank2,best=8)
plot(prune.bank2)
text(prune.bank2,pretty=0)

tree.pred=predict(prune.bank2,bank2.test,type="class")
table(tree.pred,y2.test)
```
#Tree ROC curve
```{r}
tree.pred=predict(prune.bank2,bank2.test,type="vector")
head(tree.pred)

library(ROCR)
pred <- prediction(tree.pred[,2], bank2.test$y2)
roc.perf = performance(pred, measure = "tpr", x.measure = "fpr")
#Note in the following code the term "train" means nothing here. 
#I'm just rinsing and repeating code the produces the curve.
auc.train <- performance(pred, measure = "auc")
auc.train <- auc.train@y.values
plot(roc.perf,main="AUC of Test set of a Single Tree")
abline(a=0, b= 1)
text(x = .40, y = .6,paste("AUC = ", round(auc.train[[1]],3), sep = ""))

```
#Random Forest
```{r}
rf.bank2<-randomForest(y2~.-y,bank2,subset=train,mtry=5,importance=T,ntree=100)

fit.pred<-predict(rf.bank2,newdata=bank2.test,type="response")
table(fit.pred,bank2.test$y2) #Default prediction uses .5 as cut off you can change it specifying "cutoff" option

#Overall Accuracy: TP+TN/total
(17599+1216)/41188
#Sensitivity: TP/P
(1216)/(1216+1067)
#Specificity: TN/N
(17599)/(17599+712)

rf.pred<-predict(rf.bank2,newdata=bank2.test,type="prob")
pred <- prediction(rf.pred[,2], bank2.test$y2)
roc.perf = performance(pred, measure = "tpr", x.measure = "fpr")
#Note in the following code the term "train" means nothing here. 
#I'm just rinsing and repeating code the produces the curve.
auc.train <- performance(pred, measure = "auc")
auc.train <- auc.train@y.values
plot(roc.perf,main="AUC of Test set RF - mtry=5")
abline(a=0, b= 1)
text(x = .40, y = .6,paste("AUC = ", round(auc.train[[1]],3), sep = ""))

varImpPlot (rf.bank2,type=1,main="Variable Importance")
varImpPlot (rf.car,type=2,main="Variable Importance")
```

